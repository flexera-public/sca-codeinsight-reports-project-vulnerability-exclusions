'''
Copyright 2022 Flexera Software LLC
See LICENSE.TXT for full license text
SPDX-License-Identifier: MIT

Author : sgeary  
Created On : Sat Nov 12 2022
File : report_artifacts_xlsx.py
'''
import logging
import xlsxwriter

import report_branding.xlsx.xlsx_formatting
import _version

logger = logging.getLogger(__name__)

#------------------------------------------------------------------#
def generate_xlsx_report(reportData):
    logger.info("    Entering generate_xlsx_report")

    reportName = reportData["reportName"]
    projectName  = reportData["projectName"]
    projectList  = reportData["projectList"]
    reportFileNameBase = reportData["reportFileNameBase"]
    reportTimeStamp =  reportData["reportTimeStamp"] 
    inventoryData = reportData["inventoryData"]

    xlsxFile = reportFileNameBase + ".xlsx"


    # Create the workbook/worksheet for storying the data
    workbook = xlsxwriter.Workbook(xlsxFile)
    exclusionsWorksheet = workbook.add_worksheet('Vulnerability Exclusions') 

    cellFormat = workbook.add_format(report_branding.xlsx.xlsx_formatting.standardCellFormatProperties)
    tableHeaderFormat = workbook.add_format(report_branding.xlsx.xlsx_formatting.tableHeaderFormatProperties)

    exclusionsWorksheet.set_column('A:A', 40)  # Project Name
    exclusionsWorksheet.set_column('B:B', 40)  # Component/Version
    exclusionsWorksheet.set_column('C:C', 30)  # CVE
    exclusionsWorksheet.set_column('D:D', 140)  # Exclusion Reason

    # Write the Column Headers
    row = 0
    column=0

    tableHeaders = ["PROJECT", "COMPONENT", "CVE", "EXCLUSION REASON"]

    exclusionsWorksheet.write_row(row, column , tableHeaders, tableHeaderFormat) # Write the col headers out
    row+=1
    
    for inventoryID in inventoryData:
        projectName = inventoryData[inventoryID]["projectName"]
        componentName = inventoryData[inventoryID]["componentName"]
        componentVersionName = inventoryData[inventoryID]["componentVersionName"]
        exclusions = inventoryData[inventoryID]["vulnerabilityExclusions"]

        component = componentName + " - " + componentVersionName

        for cve in exclusions:

            exclusionsWorksheet.write(row, 0, projectName, cellFormat)
            exclusionsWorksheet.write(row, 1, component, cellFormat)
            exclusionsWorksheet.write(row, 2, cve, cellFormat)
            exclusionsWorksheet.write(row, 3, exclusions[cve], cellFormat)

            row+=1

    # Automatically create the filter sort options
    exclusionsWorksheet.autofilter(0,0, 0 + row, len(tableHeaders)-1)

    print(row)

    workbook.close()

    logger.info("    Exiting generate_xlsx_report")

    return xlsxFile